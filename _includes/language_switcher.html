{% comment %}
Simple language switcher that builds locale links directly
{% endcomment %}
{% assign labels = site.data.language_labels %}
{% assign current_locale = page.lang | default: site.lang | default: "en" %}
{% assign current_label = labels[current_locale] | default: current_locale %}

{% comment %}Get supported locales{% endcomment %}
{% assign supported_locales = site.supported_locales | default: site.languages %}

{% comment %}Build locale links by finding matching pages{% endcomment %}
{% assign all_pages = site.pages %}
{% assign page_ref = page.ref | default: page.i18n_key | default: "" %}

<details class="lang-switcher" aria-label="Language selector">
  <summary class="lang-switcher__trigger">
    <span class="lang-switcher__icon" aria-hidden="true">üåê</span>
    <span class="lang-switcher__text">
      <span class="lang-switcher__eyebrow">Language</span>
      <span class="lang-switcher__current">{{ current_label }}</span>
    </span>
    <span class="lang-switcher__chevron" aria-hidden="true"></span>
  </summary>

  <div class="lang-switcher__panel" role="list">
    {% for locale in supported_locales %}
      {% comment %}Get the clean label for this locale{% endcomment %}
      {% assign locale_label = labels[locale] %}

      {% comment %}Build locale code for display (EN, ES, PT){% endcomment %}
      {% assign locale_code = locale | upcase %}
      {% if locale == "en" %}
        {% assign locale_code = "EN" %}
      {% elsif locale == "es-419" %}
        {% assign locale_code = "ES" %}
      {% elsif locale == "pt-br" or locale == "pt-BR" %}
        {% assign locale_code = "PT" %}
      {% endif %}

      {% comment %}Find the matching page for this locale{% endcomment %}
      {% assign target_page = nil %}
      {% if page_ref != "" %}
        {% for p in all_pages %}
          {% assign p_ref = p.ref | default: p.i18n_key %}
          {% if p_ref == page_ref and p.lang == locale %}
            {% assign target_page = p %}
            {% break %}
          {% endif %}
        {% endfor %}
      {% endif %}

      {% comment %}Fallback to locale homepage if no match found{% endcomment %}
      {% if target_page %}
        {% assign target_url = target_page.url | default: target_page.permalink %}
      {% else %}
        {% if locale == "en" %}
          {% assign target_url = "/en/" %}
        {% elsif locale == "es-419" %}
          {% assign target_url = "/es-419/" %}
        {% elsif locale == "pt-br" or locale == "pt-BR" %}
          {% assign target_url = "/pt-br/" %}
        {% else %}
          {% assign target_url = "/" %}
        {% endif %}
      {% endif %}

      <a class="lang-switcher__option {% if current_locale == locale %}is-active{% endif %}"
         href="{{ target_url | relative_url }}"
         {% if current_locale == locale %}aria-current="page"{% endif %}
         role="listitem">
        <span class="lang-switcher__code">{{ locale_code }}</span>
        <span class="lang-switcher__label">
          <strong>{{ locale_label }}</strong>
          <small class="lang-switcher__hint">{{ target_url }}</small>
        </span>
      </a>
    {% endfor %}
  </div>
</details>
