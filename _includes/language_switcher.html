{% assign labels = site.data.language_labels | default: {} %}
{% assign locales_source = site.supported_locales | default: site.languages | default: "en" %}
{% assign locales = locales_source %}
{% assign locales_json = locales_source | jsonify %}
{% if locales_json | slice: 0, 1 != "[" %}
  {% assign locales = locales_source | split: "," %}
{% endif %}

{% assign ref_key = page.ref | default: page.i18n_key | default: "" %}
{% include translation_targets.html ref=ref_key locales=locales %}

{% assign current_locale = page.lang | default: site.lang | default: locales.first %}
{% unless locales contains current_locale or current_locale == "x-default" %}
  {% assign current_locale = locales.first %}
{% endunless %}
{% if current_locale == "x-default" %}
  {% assign current_label = labels[current_locale] | default: "Global" %}
{% else %}
  {% assign current_label = labels[current_locale] | default: current_locale %}
{% endif %}

<details class="lang-switcher" aria-label="Language selector">
  <summary class="lang-switcher__trigger">
    <span class="lang-switcher__icon" aria-hidden="true">üåê</span>
    <span class="lang-switcher__text">
      <span class="lang-switcher__eyebrow">Language</span>
      <span class="lang-switcher__current">{{ current_label }}</span>
    </span>
    <span class="lang-switcher__chevron" aria-hidden="true"></span>
  </summary>

  <div class="lang-switcher__panel" role="list">
    {% for entry in translation_targets %}
      {% assign parts = entry | split: "||" %}
      {% assign locale = parts[0] %}
      {% assign target = parts[1] %}
      {% assign locale_label = labels[locale] | default: locale %}

      {% assign locale_code = locale | split: "-" | last | upcase %}
      {% if locale == "en" %}{% assign locale_code = "EN" %}{% endif %}
      {% if locale == "es-419" %}{% assign locale_code = "ES" %}{% endif %}
      {% if locale == "x-default" %}{% assign locale_code = "XD" %}{% endif %}

      {% if locale == "x-default" %}
        {% assign locale_label = locale_label | default: "Global" %}
      {% endif %}

      <a class="lang-switcher__option {% if page.lang == locale %}is-active{% endif %}" href="{{ target | relative_url }}" {% if page.lang == locale %}aria-current="page"{% endif %} role="listitem">
        <span class="lang-switcher__code">{{ locale_code }}</span>
        <span class="lang-switcher__label">
          <strong>{{ locale_label }}</strong>
          <small class="lang-switcher__hint">{{ target }}</small>
        </span>
      </a>
    {% endfor %}
  </div>
</details>
